#include <iostream>
#include <string>
#include <windows.h>
#include <conio.h>
#include "Inventory.h"
#include "Player.h"
#include "World.h"
#include "Button.h"


static const HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);
static const HANDLE hIn = GetStdHandle(STD_INPUT_HANDLE);
static CONSOLE_FONT_INFOEX  font;


vector<string> createMap(){
    vector<string> map;
    map.emplace_back("--------------************----------------###############-------------------------------------------");
    map.emplace_back("----------------**********-----------------###########----------------------------------------------");
    map.emplace_back("-------------------*****----------------------####--------------------------------------------------");
    map.emplace_back("----------------------------------------------------------------------------------------------------");
    map.emplace_back("----------|||||||||||----------------------------------------------************---------------------");
    map.emplace_back("--------|||||||||||||||||-----------------------------------------********,,*****-------------------");
    map.emplace_back("---------|||||||||||||||||----------------------------------------******,,,,******------------------");
    map.emplace_back("----------||||||||||||||||-----------------------------------------*******,,,******-----------------");
    map.emplace_back("-----------|||||||||||||---------------------------------------------*******,,******----------------");
    map.emplace_back("-------------|||||||||-------------------------------------------------******,******----------------");
    map.emplace_back("---------------|||||-----------------------------------------------------**********-----------------");
    map.emplace_back("----------------------------------------------------------------------------------------------------");
    map.emplace_back("----------------------------------------------------------------------------------------------------");
    map.emplace_back("----------------------------------------------------------------------------------------------------");
    map.emplace_back("----------------------------------------------------------------------------------------------------");
    map.emplace_back("----------------------------------------------------------------------------------------------------");
    map.emplace_back("-----------------------------------*******-----------------------------------------------------#####");
    map.emplace_back("#######-----------------------****************--------------------------------------------##########");
    map.emplace_back("##########-----------------**********************--------------------------------------#############");
    map.emplace_back("--##########-------------*********,,,,,,,,*********---------------------------------############----");
    map.emplace_back("----#########------------*******,,,,,,,,,,,,,********----------------------------#############------");
    map.emplace_back("-----#########-----------*******,,,,,,,,,,,,,,********------------------------###############-------");
    map.emplace_back("---###########-----------********,,,,,,,,,,,,,*********---------------------#####################---");
    map.emplace_back("##############-------------*****************************-------------------#########################");
    map.emplace_back("#############----------------****************************------------------#########################");
    map.emplace_back("-#########-------------------------***********************-----------------#####################----");
    map.emplace_back("------------------------------------------*****************------------------##########-------------");
    map.emplace_back("----------------------------------------------**************----------------------------------------");
    map.emplace_back("-------------------------------------------------************---------------------------------------");
    map.emplace_back("-------------------------------------------------------***--------------|||||-----------------------");
    map.emplace_back("*****-----------------------#########--------------------------------||||||||||---------------******");
    map.emplace_back("**********----------------###############--------------------------||||||||||||||----------*********");
    map.emplace_back(",,,*********--------------###################-----------------------|||||||||||||--------*********,,");
    map.emplace_back(",,,,,,********-------------######################-------------------|||||||||||||||-----********,,,,");
    map.emplace_back(",,,,,,,,********------------##########################----------------||||||||----------*******,,,,,");
    map.emplace_back(",,,,,,,,*********------------##############################--------------|||------------********,,,,");
    map.emplace_back(",,,,,,,***********-------------###############################---------------------------*********,,");
    map.emplace_back("********************--------------#############################---------------------------**********");
    map.emplace_back("*********************---------------###########################------------------------------*******");
    map.emplace_back("------*****************----------------######################---------------------------------------");
    map.emplace_back("--------------************----------------###############-------------------------------------------");
    map.emplace_back("----------------**********-----------------###########----------------------------------------------");
    map.emplace_back("-------------------*****----------------------####--------------------------------------------------");
    map.emplace_back("----------------------------------------------------------------------------------------------------");
    map.emplace_back("----------|||||||||||----------------------------------------------************---------------------");
    map.emplace_back("--------|||||||||||||||||-----------------------------------------********,,*****-------------------");
    map.emplace_back("---------|||||||||||||||||----------------------------------------******,,,,******------------------");
    map.emplace_back("----------||||||||||||||||-----------------------------------------*******,,,******-----------------");
    map.emplace_back("-----------|||||||||||||---------------------------------------------*******,,******----------------");
    map.emplace_back("-------------|||||||||-------------------------------------------------******,******----------------");
    map.emplace_back("---------------|||||-----------------------------------------------------**********-----------------");
    map.emplace_back("----------------------------------------------------------------------------------------------------");
    map.emplace_back("----------------------------------------------------------------------------------------------------");
    map.emplace_back("----------------------------------------------------------------------------------------------------");
    map.emplace_back("----------------------------------------------------------------------------------------------------");
    map.emplace_back("----------------------------------------------------------------------------------------------------");
    map.emplace_back("-----------------------------------*******-----------------------------------------------------#####");
    map.emplace_back("#######-----------------------****************--------------------------------------------##########");
    map.emplace_back("##########-----------------**********************--------------------------------------#############");
    map.emplace_back("--##########-------------*********,,,,,,,,*********---------------------------------############----");
    map.emplace_back("----#########------------*******,,,,,,,,,,,,,********----------------------------#############------");
    map.emplace_back("-----#########-----------*******,,,,,,,,,,,,,,********------------------------###############-------");
    map.emplace_back("---###########-----------********,,,,,,,,,,,,,*********---------------------#####################---");
    map.emplace_back("##############-------------*****************************-------------------#########################");
    map.emplace_back("#############----------------****************************------------------#########################");
    map.emplace_back("-#########-------------------------***********************-----------------#####################----");
    map.emplace_back("------------------------------------------*****************------------------##########-------------");
    map.emplace_back("----------------------------------------------**************----------------------------------------");
    map.emplace_back("-------------------------------------------------************---------------------------------------");
    map.emplace_back("-------------------------------------------------------***--------------|||||-----------------------");
    map.emplace_back("*****-----------------------#########--------------------------------||||||||||---------------******");
    map.emplace_back("**********----------------###############--------------------------||||||||||||||----------*********");
    map.emplace_back(",,,*********--------------###################-----------------------|||||||||||||--------*********,,");
    map.emplace_back(",,,,,,********-------------######################-------------------|||||||||||||||-----********,,,,");
    map.emplace_back(",,,,,,,,********------------##########################----------------||||||||----------*******,,,,,");
    map.emplace_back(",,,,,,,,*********------------##############################--------------|||------------********,,,,");
    map.emplace_back(",,,,,,,***********-------------###############################---------------------------*********,,");
    map.emplace_back("********************--------------#############################---------------------------**********");
    map.emplace_back("*********************---------------###########################------------------------------*******");
    map.emplace_back("------*****************----------------######################---------------------------------------");
    map.emplace_back("----#########------------*******,,,,,,,,,,,,,********----------------------------#############------");
    map.emplace_back("-----#########-----------*******,,,,,,,,,,,,,,********------------------------###############-------");
    map.emplace_back("---###########-----------********,,,,,,,,,,,,,*********---------------------#####################---");
    map.emplace_back("##############-------------*****************************-------------------#########################");
    map.emplace_back("#############----------------****************************------------------#########################");
    map.emplace_back("-#########-------------------------***********************-----------------#####################----");
    map.emplace_back("------------------------------------------*****************------------------##########-------------");
    map.emplace_back("----------------------------------------------**************----------------------------------------");
    map.emplace_back("-------------------------------------------------************---------------------------------------");
    map.emplace_back("-------------------------------------------------------***--------------|||||-----------------------");
    map.emplace_back("*****-----------------------#########--------------------------------||||||||||---------------******");
    map.emplace_back("**********----------------###############--------------------------||||||||||||||----------*********");
    map.emplace_back(",,,*********--------------###################-----------------------|||||||||||||--------*********,,");
    map.emplace_back(",,,,,,********-------------######################-------------------|||||||||||||||-----********,,,,");
    map.emplace_back(",,,,,,,,********------------##########################----------------||||||||----------*******,,,,,");
    map.emplace_back(",,,,,,,,*********------------##############################--------------|||------------********,,,,");
    map.emplace_back(",,,,,,,***********-------------###############################---------------------------*********,,");
    map.emplace_back("********************--------------#############################---------------------------**********");
    map.emplace_back("*********************---------------###########################------------------------------*******");
    map.emplace_back("------*****************----------------######################---------------------------------------");
    return map;
}
void set_cursor(bool visible){
    CONSOLE_CURSOR_INFO info;
    info.dwSize = 100;
    info.bVisible = visible;
    SetConsoleCursorInfo(GetStdHandle(STD_OUTPUT_HANDLE), &info);
}
void GetMouseCursorPos(POINT *mC)
{
    font.cbSize = sizeof(CONSOLE_FONT_INFOEX);
    GetCurrentConsoleFontEx(hOut, 0, &font);
    GetCursorPos(mC);
    mC->y = mC->y-22.5; mC->x = mC->x/font.dwFontSize.X; mC->y = mC->y/font.dwFontSize.Y;
}

int main() {
    font.cbSize = sizeof(CONSOLE_FONT_INFOEX);
    GetCurrentConsoleFontEx(hOut, 0, &font);
    font.FontWeight = 700;
    font.dwFontSize.X = 10;
    font.dwFontSize.Y = 10;

    SetConsoleMode(hIn, ENABLE_MOUSE_INPUT | ENABLE_EXTENDED_FLAGS);
    ShowWindow(GetConsoleWindow(), SW_MAXIMIZE);
    set_cursor(false);


    World world;
    Player player;
    POINT mCoord;
    world.addPlayer(player);
    COORD topLeft = { 0, 0 };

    vector<string> map = createMap();
    world.setMap(map);
    SetConsoleCursorPosition(hOut, topLeft);
    while (true) {
        SetConsoleCursorPosition(hOut, topLeft);
        world.updatePlayer(player);
        world.printMap(player);
        if (GetAsyncKeyState(VK_ESCAPE)) {
            system("cls");
            Button back;
            back.height = 3; back.width = 116; back.x = 50; back.y = 10;
            //Button settings;
            //Button quit;
            while (true) {
                back.print();
                if (GetAsyncKeyState(VK_LBUTTON)){
                    GetMouseCursorPos(&mCoord);
                    if (back.isPressed(mCoord.x, mCoord.y)){
                        system("cls");
                        break;
                    }
                }
            }
        }
        else if (GetAsyncKeyState(VK_LBUTTON)) {
            GetMouseCursorPos(&mCoord);
            cout << mCoord.x << " " << mCoord.y << endl;
        }
        else if (GetAsyncKeyState(VK_UP)) player.setSymbol("^");
        else if (GetAsyncKeyState(VK_DOWN)) player.setSymbol("v");
        else if (GetAsyncKeyState(VK_LEFT)) player.setSymbol("<");
        else if (GetAsyncKeyState(VK_RIGHT)) player.setSymbol(">");
        else if (GetAsyncKeyState(0x57)) player.moveUp(world.getMap());
        else if (GetAsyncKeyState(0x53)) player.moveDown(world.getMap());
        else if (GetAsyncKeyState(0x44)) player.moveRight(world.getMap());
        else if (GetAsyncKeyState(0x41)) player.moveLeft(world.getMap());
    }
}

